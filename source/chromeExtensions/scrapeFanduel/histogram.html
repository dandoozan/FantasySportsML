<html>
  <head>
		<style>
			body {
				margin:0 0 0 -10;
				padding:0;
				overflow:hidden;
			}
    </style>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
		
			var boxplotLocation=-21
			
			var data, max, min, avg, stdev, q1, median, q3, net, curravg;
			window.addEventListener('message', function(event) {
				max=event.data.stats.max
				min=event.data.stats.min
				avg=event.data.stats.avg
				stdev=event.data.stats.stdev
				q1=event.data.stats.q1
				median=event.data.stats.median
				q3=event.data.stats.q3
				net=event.data.stats.net
				curravg=event.data.stats.curravg
				data=event.data.results;
			});
		
			
			//google.load('visualization', '1', {'packages':['annotatedtimeline']});
			google.load("visualization", "1", {packages:["corechart"]});
			google.setOnLoadCallback(drawChart);
			function drawChart() {
				var intrvl = setInterval(function(){
					if(data){
						clearInterval(intrvl);
						
						//separate into bins
						var binIntrvl=10
						var minValue=Math.floor(avg-3*stdev)
						var maxValue=Math.ceil(avg+3*stdev)
						var numberOfBins=Math.ceil((maxValue-minValue)/binIntrvl)+1;
						var start=Math.round(minValue-(minValue%binIntrvl));
						var bins=[]
						for(var i=0;i<numberOfBins;i++){
							bins.push({intrvl:start+(i*binIntrvl), count:0});
						}
						for(var i=1;i<data.length;i++){
							var price=data[i].price
							if(price>=minValue && price<=maxValue){
								var bin=Math.floor((Math.round(price)-start)/binIntrvl)
								bins[bin].count+=1
							}
						}
						//var avgbin=Math.floor((avg-start)/binIntrvl)
						var lowbin1=Math.floor(((avg-stdev)-start)/binIntrvl)
						//var lowbin2=Math.floor(((avg-2*stdev)-start)/binIntrvl)
						var highbin1=Math.floor(((avg+stdev)-start)/binIntrvl)
						//var highbin2=Math.floor(((avg+2*stdev)-start)/binIntrvl)
						
						var maxCount=0;
						var chartdata=[['Bin', 'Stats', 'Count', 'Count', 'Cumulative', 'Min', 'Max', 'Fence', 'IQR', 'Median', 'Fence', 'Net', 'Avg']]
						var cumulativePercent=100.0
						for(var i=0;i<bins.length;i++){
							var percent=bins[i].count/(data.length)*100
							
							//var statvalue=null
							//if(i==avgbin || i==lowbin1 || i==highbin1 || i==lowbin2 || i==highbin2)
							//	statvalue=0
							
							if(i>=lowbin1 && i<=highbin1)
								chartdata.push([bins[i].intrvl, null, null, bins[i].count, Math.round(cumulativePercent), null, null, null, null, null, null, null, null])
							else
								chartdata.push([bins[i].intrvl, null, bins[i].count, null, Math.round(cumulativePercent), null, null, null, null, null, null, null, null])
							
							if(bins[i].count>maxCount)
								maxCount=bins[i].count
								
							cumulativePercent-=percent
						}
						
						//avg, stdevs
						chartdata.push([(avg-2*stdev), 0, null, null, null, null, null, null, null, null, null, null, null])
						chartdata.push([(avg-stdev), 0, null, null, null, null, null, null, null, null, null, null, null])
						chartdata.push([avg, 0, null, null, null, null, null, null, null, null, null, null, null])
						chartdata.push([(avg+stdev), 0, null, null, null, null, null, null, null, null, null, null, null])
						chartdata.push([(avg+2*stdev), 0, null, null, null, null, null, null, null, null, null, null, null])
						
						
						//boxplot
						var lowFence=Math.max(min, q1-1.5*(q3-q1))
						var highFence=Math.min(max, q3+1.5*(q3-q1))
						chartdata.push([min, null, null, null, null, boxplotLocation, null, null, null, null, null, null, null])
						chartdata.push([max, null, null, null, null, null, boxplotLocation, null, null, null, null, null, null])
						chartdata.push([0, null, null, null, null, null, null, null, null, null, boxplotLocation, null, null]) //tbd, for the dashed line
						chartdata.push([lowFence, null, null, null, null, null, null, boxplotLocation, null, null, null, null, null])
						//chartdata.push([1, null, null, null, null, null, null, null, null, null, boxplotLocation]) //tbd, for the dashed line
						/*for(var i=lowFence;i<highFence;i+=8){
							chartdata.push([i, null, null, null, null, null, null, null, null, null, boxplotLocation])
							chartdata.push([i+4, null, null, null, null, null, null, null, null, null, boxplotLocation])
							chartdata.push([i+5, null, null, null, null, null, null, null, null, null, null])
						}*/
						chartdata.push([highFence, null, null, null, null, null, null, boxplotLocation, null, null, null, null, null])
						chartdata.push([q1, null, null, null, null, null, null, null, boxplotLocation, null, null, null, null])
						chartdata.push([q3, null, null, null, null, null, null, null, boxplotLocation, null, null, null, null])
						//chartdata.push([median-10, null, null, null, null, null, null, null, null, boxplotLocation, null, null, null])
						chartdata.push([median, null, null, null, null, null, null, null, null, boxplotLocation, null, null, null])
						
						//net, avg
						chartdata.push([net, null, null, null, null, null, null, null, null, null, null, -2.5, null])
						chartdata.push([curravg, null, null, null, null, null, null, null, null, null, null, null, -2.5])
						
						
						var gdata=google.visualization.arrayToDataTable(chartdata);
						
						/*var gdata = google.visualization.arrayToDataTable([
							['Year', 'Sales', 'Expenses'],
							['2004',  1000,      400],
							['2005',  1170,      460],
							['2006',  660,       1120],
							['2007',  1030,      540]
						]);*/

						var options = {
							bar: {groupWidth:'80%'},
							legend: {position:'none'},
							//series:{1:{targetAxisIndex:1}}, vAxes:{1:{title:'Losses',textStyle:{color: 'red'}}},
							hAxis: {title:'Price (interval=$'+binIntrvl+')', format:'$#', viewWindowMode:'explicit', viewWindow:{min:Math.max(0,minValue), max:Math.min(max,maxValue)}},//, gridlines:{count:numberOfBins/2}, showTextEvery:2},
							vAxis: {gridlines:{count:1}}, //minorGridlines:{count:5}},
							title: 'Price Distribution (mu=$'+avg.toFixed(0)+', sigma=$'+stdev.toFixed(0)+')',
							focusTarget: 'category',
							seriesType: "line",
							isStacked:true,
							/*grayscale
							series:
								{0:{lineWidth:0, pointSize:4, color:'black'}, //stats
								 1:{type:"bars", targetAxisIndex:1, color:'#bbb'}, //color:'ADC2EB'}, //>1SD
								 2:{type:"bars", targetAxisIndex:1, color:'#777'}, //color:'3366cc'}, //<=1SD
								 3:{lineWidth:1, pointSize:1, color:'#888'},
								 4:{pointSize:3, color:'#aaa'},
								 5:{pointSize:3, color:'#aaa'},
								 6:{lineWidth:1, pointSize:3, color:'#aaa'}, //fence
								 7:{lineWidth:18, color:'#666'}, //mid50
								 8:{lineWidth:16, color:'black'}, //median
								 9:{lineWidth:1, color:'black'}, //fence
								 10:{lineWidth:0, pointSize:8, color:'green'}}, //net
								vAxes:{0:{title:'Percent', viewWindowMode:'explicit', viewWindow:{min:-100/3, max:100}}, 1:{textStyle:{color:'3366cc'}, viewWindowMode:'explicit', viewWindow:{min:-maxCount/3, max:maxCount}}}*/
							series: 
								{0:{lineWidth:0, pointSize:3, color:'black'}, //stats
								 1:{type:"bars", targetAxisIndex:1, color:'8FABE3'}, //color:'ADC2EB'}, //>1SD
								 2:{type:"bars", targetAxisIndex:1, color:'3366cc'}, //color:'3366cc'}, //<=1SD
								 3:{lineWidth:1, pointSize:1, color:'#888'}, //cumulative
								 4:{pointSize:3, color:'999'}, //min
								 5:{pointSize:3, color:'999'}, //max
								 6:{lineWidth:1, pointSize:3, color:'999'}, //fence
								 7:{lineWidth:16, color:'999'},// color:'FF3333'}, //mid50
								 8:{lineWidth:14, color:'black'}, //median
								 9:{lineWidth:1, color:'black'}, //fence
								 10:{lineWidth:0, pointSize:6, color:'ff9900'}, //net
								 11:{lineWidth:0, pointSize:6, color:'dc3912'}}, //curravg
								vAxes:{0:{title:'Percent', viewWindowMode:'explicit', viewWindow:{min:-100/3, max:100}}, 
											 1:{textStyle:{color:'3366cc'}, viewWindowMode:'explicit', viewWindow:{min:-maxCount/3, max:maxCount}}}
						};

						//var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
						var chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
						chart.draw(gdata, options);
					}
				},100);
			}
    </script>
  </head>
  <body>
    <div id="chart_div" style="width:315; height:175;"></div>
  </body>
</html>